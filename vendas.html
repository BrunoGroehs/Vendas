<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vendas - Gest√£o Lavagem de Placas</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="css/components-new.css">
<style>
  .customer-link {
    color: #2563eb;
    text-decoration: none;
    cursor: pointer;
  }
  .customer-link:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar__logo">üßº Lavagem</div>
    <nav class="sidebar__nav">
      <a href="index.html">Dashboard</a>
      <a href="clientes.html">Clientes</a>
      <a href="vendas.html" class="active">Vendas</a>
      <a href="recontato.html">Recontato</a>
      <a href="despesas.html">Despesas</a>
      <a href="relatorios.html">Relat√≥rios</a>
      <a href="#">Configura√ß√µes</a>
    </nav>
  </aside>
 
  <!-- Main content -->
  <div class="main">
    <!-- Header -->
    <header class="header">
      <div class="breadcrumb">Vendas</div>
      <div class="header__actions">
        <input type="text" placeholder="Buscar venda..." class="header__search" id="salesSearch"/>
        <button class="btn btn--primary" id="newSaleBtn">Nova Venda</button>
      </div>
    </header>
 
    <!-- Body -->
    <main class="content">
      <section class="metrics">
        <div class="metric-tile">
          <span class="metric-label">Total Vendas</span>
          <span class="metric-value" id="totalSales">0</span>
        </div>
        <div class="metric-tile">
          <span class="metric-label">Receita Total</span>
          <span class="metric-value" id="totalRevenue">R$ 0.00</span>
        </div>
        <div class="metric-tile">
          <span class="metric-label">Ticket M√©dio</span>
          <span class="metric-value" id="averageTicket">R$ 0.00</span>
        </div>
        <div class="metric-tile">
          <span class="metric-label">Comiss√µes</span>
          <span class="metric-value" id="totalCommissions">R$ 0.00</span>
        </div>
      </section>

      <section class="sales-list">
        <div class="table-container">
          <table class="data-table">            <thead>
              <tr>
                <th>Data</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Comiss√£o</th>
                <th>Notas</th>
              </tr>
            </thead>
            <tbody id="salesTableBody">
              <!-- Preenchido via JavaScript -->
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="js/modules/toast.js"></script>
<script src="js/modules/components.js"></script>
<script src="js/modules/api.js"></script>
<script src="js/modules/services-new.js"></script>
<script src="js/modules/customers-new.js"></script>
<script src="js/modules/notifications-new.js"></script>
<script src="js/app.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Verificar se API est√° carregada
  if (!window.API && window.ensureAPILoaded) {
    await window.ensureAPILoaded();
  }
  
  // Iniciar m√≥dulo
  window.ServicesModule.init();
  
  // Cache de elementos DOM
  const salesTableBody = document.getElementById('salesTableBody');
  const searchInput = document.getElementById('salesSearch');
  const newSaleBtn = document.getElementById('newSaleBtn');
  
  // M√©tricas
  const totalSalesEl = document.getElementById('totalSales');
  const totalRevenueEl = document.getElementById('totalRevenue');
  const averageTicketEl = document.getElementById('averageTicket');
  const totalCommissionsEl = document.getElementById('totalCommissions');
  // Formatar moeda
  const formatCurrency = value => {
    // Garantir que value √© um n√∫mero
    const numValue = Number(value) || 0;
    return `R$ ${numValue.toFixed(2)}`;
  };
    // Fun√ß√£o para calcular e exibir m√©tricas
  async function renderMetrics() {
    try {
      // Verificar se API est√° dispon√≠vel
      if (!window.API) {
        console.error('API n√£o est√° dispon√≠vel');
        window.showToast('Erro ao conectar com a API', 'error');
        return;
      }      // Buscar servi√ßos da API
      const services = await window.API.getServices() || [];
      
      const totalSales = services.length;
      const totalRevenue = services.reduce((sum, s) => sum + (Number(s.price) || 0), 0);
      const averageTicket = totalSales > 0 ? totalRevenue / totalSales : 0;
      const totalCommissions = services.reduce((sum, s) => {
        const price = Number(s.price) || 0;
        const commissionPct = Number(s.commissionPct) || 10;
        return sum + (price * commissionPct / 100);
      }, 0);
      
      // Atualizar elementos
      totalSalesEl.textContent = totalSales;
      totalRevenueEl.textContent = formatCurrency(totalRevenue);
      averageTicketEl.textContent = formatCurrency(averageTicket);
      totalCommissionsEl.textContent = formatCurrency(totalCommissions);
    } catch (error) {
      console.error('Erro ao carregar m√©tricas:', error);
      window.showToast('Erro ao carregar m√©tricas', 'error');
    }
  }
    // Fun√ß√£o para renderizar a lista de vendas
  async function renderSalesList(searchText = '') {
    try {
      // Verificar se API est√° dispon√≠vel
      if (!window.API) {
        console.error('API n√£o est√° dispon√≠vel');
        window.showToast('Erro ao conectar com a API', 'error');
        return;
      }      // Buscar servi√ßos e clientes da API
      const [services, customers, appointments] = await Promise.all([
        window.API.getServices(),
        window.API.getCustomers(),
        window.API.getAppointments()
      ]);
        // Filtrar vendas
      const filteredServices = services
        .filter(service => {
          if (!searchText) return true;
          
          // Busca pelo nome do cliente
          const clientId = service.customerId || service.customerid;
          const customer = customers.find(c => c.id === clientId);
          if (customer && customer.name && customer.name.toLowerCase().includes(searchText.toLowerCase())) {
            return true;
          }
          
          // Busca pela data do servi√ßo
          const dateValue = service.serviceDate || service.servicedate;
          if (dateValue && typeof dateValue === 'string' && dateValue.includes(searchText)) {
            return true;
          }
          
          // Busca pelo valor
          const price = service.price;
          if (price !== undefined && price !== null && String(price).includes(searchText)) {
            return true;
          }
          
          return false;        })
        .sort((a, b) => {
          // Considerar ambas as formas de armazenamento da data (serviceDate ou servicedate)
          const dateA = a.serviceDate || a.servicedate || '1970-01-01';
          const dateB = b.serviceDate || b.servicedate || '1970-01-01';
          return new Date(dateB) - new Date(dateA);
        });
      
      // Limpar tabela
      salesTableBody.innerHTML = '';      // Preencher com servi√ßos
      filteredServices.forEach(service => {
        // A API pode retornar customerId ou customerid - vamos verificar ambos
        const clientId = service.customerId || service.customerid;
        
        // Tentamos encontrar o cliente pelo id usando ambas as formas (case sensitive ou n√£o)
        const customer = customers.find(c => 
          c.id === clientId || 
          (typeof c.id === 'string' && typeof clientId === 'string' && c.id.toLowerCase() === clientId.toLowerCase()));
        
          // Encontrar pr√≥ximo agendamento (garantindo que appointments √© um array v√°lido)
        const nextAppointment = Array.isArray(appointments) ? appointments
          .filter(a => a && a.createdFromServiceId === service.id && a.status === 'PENDING')
          .sort((a, b) => new Date(a.scheduledFor) - new Date(b.scheduledFor))[0] : null;// Calcular comiss√£o (garantindo que price e commissionPct s√£o n√∫meros)
      const price = Number(service.price) || 0;
      const commissionPct = Number(service.commissionPct) || 10; // Usar 10% como padr√£o se n√£o estiver definido
      const commission = price * (commissionPct / 100);
      
      // Criar linha
      const tr = document.createElement('tr');      // Data com hor√°rio
      const tdDate = document.createElement('td');      // Verificar se a data existe
      if (!service.serviceDate && !service.servicedate) {
        tdDate.textContent = "Data n√£o dispon√≠vel";
      } else {
        const dateValue = service.serviceDate || service.servicedate;
        const serviceDate = new Date(dateValue);
        // Verificar se a data tem informa√ß√£o de hora (formato com T)
        if (dateValue.includes('T')) {
          tdDate.textContent = `${serviceDate.toLocaleDateString('pt-BR')} ${serviceDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
        } else {
          // Se n√£o tiver hor√°rio espec√≠fico, adicionar um hor√°rio padr√£o (09:00)
          tdDate.textContent = `${serviceDate.toLocaleDateString('pt-BR')} 09:00`;
        }
      }
      tdDate.classList.add('highlight-cell');      // Cliente
      const tdCustomer = document.createElement('td');
      if (customer) {
        tdCustomer.innerHTML = `<a href="#" class="customer-link">${customer.name}</a>`;
        tdCustomer.querySelector('.customer-link').addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation(); // Prevent event from bubbling up to row
          // Use the reusable component if available, otherwise fallback
          if (window.ComponentsModule && typeof window.ComponentsModule.showCustomerDetailsModal === 'function') {
            window.ComponentsModule.showCustomerDetailsModal(customer.id);
          } else if (window.CustomersModule && typeof window.CustomersModule.showCustomerDetails === 'function') {
            window.CustomersModule.showCustomerDetails(customer.id);
          } else {
            window.showToast('Detalhes do cliente em implementa√ß√£o', 'warning');
          }
        });
      } else {
        tdCustomer.textContent = 'Cliente n√£o encontrado';
      }
      
      // Valor
      const tdPrice = document.createElement('td');
      tdPrice.textContent = formatCurrency(service.price);
        // Comiss√£o
      const tdCommission = document.createElement('td');
      tdCommission.textContent = formatCurrency(commission);
      
      // Notas
      const tdNotes = document.createElement('td');
      tdNotes.textContent = service.notes || '-';
      tdNotes.classList.add('service-description');
      
      // Adicionar c√©lulas √† linha
      tr.append(tdDate, tdCustomer, tdPrice, tdCommission, tdNotes);
      
      // Adicionar linha √† tabela
      salesTableBody.appendChild(tr);
    });
    } catch (error) {
      console.error('Erro ao carregar lista de vendas:', error);
      window.showToast('Erro ao carregar lista de vendas', 'error');
      
      // Limpar tabela e mostrar mensagem de erro
      salesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Erro ao carregar vendas. Tente novamente mais tarde.</td></tr>';
    }
  }
  // Eventos
  searchInput.addEventListener('input', e => {
    renderSalesList(e.target.value);
  });
      newSaleBtn.addEventListener('click', () => {
    console.log('Abrindo modal de Nova Venda...');
    window.ServicesModule.showNewServiceModal();
    renderMetrics();
    renderSalesList();
  });
  
  // Ouvir por altera√ß√µes no m√≥dulo de servi√ßos
  document.addEventListener('serviceAdded', () => {
    renderMetrics();
    renderSalesList();
  });
  
  // Inicializa√ß√£o
  // Verificar se a API est√° dispon√≠vel, e se n√£o estiver, esperar at√© que esteja
  const ensureAPILoaded = async () => {
    if (!window.API) {
      console.log('Aguardando a API ser carregada...');
      // Esperar por at√© 5 segundos pela API
      for (let i = 0; i < 10; i++) {
        await new Promise(resolve => setTimeout(resolve, 500));
        if (window.API) break;
      }
      
      // Se ainda n√£o temos API, mostrar um erro
      if (!window.API) {
        console.error('API n√£o p√¥de ser carregada ap√≥s v√°rias tentativas');
        window.showToast('Erro ao carregar API. Algumas funcionalidades podem estar limitadas.', 'error');
      }
    }
    
    // Iniciar a renderiza√ß√£o dos dados
    renderMetrics();
    renderSalesList();
  };
  
  ensureAPILoaded();
});
</script>
</body>
</html>
